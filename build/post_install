#!/bin/bash
set -xe
cd /root/build
/bin/rm -f /etc/yum.repos.d/*.repo*
install -o root -g root -m 644 local.repo /etc/yum.repos.d/

# Create "firstuser" unpriv shell account
groupadd -g 500 firstuser
# $ echo firstuser1234 | openssl passwd -stdin -1
useradd -u 500 -g 500 -d /home/firstuser -s /bin/bash -p '$1$xgBMWsf3$rae38nIFO3G1TacXTT2cr.' firstuser
# Lock root account
usermod -L root

/bin/rm -f /etc/local/time
cp -p /usr/share/zoneinfo/UTC /etc/localtime

yum clean all
yum -y update

# Purge CentOS repo files that get put on the system with every dot-rev OS update
find /etc/yum.repos.d/ -type f -name '*.repo' '!' -name 'local.repo' | xargs -d '\n' /bin/rm -f

# Add basic required packages
yum -y install curl nc openssh-clients rpm ruby ruby-libs sudo tar unzip zip yum wget runit

chmod 640 /etc/sudoers
echo "%wheel    ALL=(ALL)       ALL" >> /etc/sudoers
echo "firstuser ALL=(ALL)       ALL" >> /etc/sudoers
# Make sure root can run app_start without a tty or password
sed -i -e 's/^Defaults.*requiretty/Defaults !requiretty/' /etc/sudoers
egrep '^Defaults.*tty' /etc/sudoers
chmod 440 /etc/sudoers

cd /root/build
curl -o ks_gpg_keys.zip $ksurl/centos6_gpg_keys.zip
unzip -o -d /etc/pki/rpm-gpg/ ks_gpg_keys.zip
cd /etc/pki/rpm-gpg
for f in $(/bin/ls -1 RPM-GPG-KEY-*); do
    rpm --import $f
done

cd /root/build
yum -y install ruby-shadow ruby-augeas puppet facter
yum -y clean all

